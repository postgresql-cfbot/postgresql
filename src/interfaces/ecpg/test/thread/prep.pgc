#include <stdint.h>
#include <stdlib.h>
#include "ecpg_config.h"
#include "port/pg_threads.h"

#include <stdio.h>

#define THREADS		16
#define REPEATS		50

exec sql include sqlca;
exec sql include ../regression;

exec sql whenever sqlerror sqlprint;
exec sql whenever not found sqlprint;

static int fn(void* arg)
{
	int i;

	EXEC SQL BEGIN DECLARE SECTION;
	int  value;
	char name[100];
	char query[256] = "INSERT INTO T VALUES ( ? )";
	EXEC SQL END DECLARE SECTION;

	value = (intptr_t) arg;
	sprintf(name, "Connection: %d", value);

	EXEC SQL CONNECT TO REGRESSDB1 AS :name;
	EXEC SQL SET AUTOCOMMIT TO ON;
	for (i = 1; i <= REPEATS; ++i)
	{
		EXEC SQL PREPARE I FROM :query;
		EXEC SQL EXECUTE I USING :value;
	}
	EXEC SQL DEALLOCATE I;
	EXEC SQL DISCONNECT :name;

	return 0;
}

int main ()
{
	intptr_t i;
	pg_thrd_t threads[THREADS];

	EXEC SQL CONNECT TO REGRESSDB1;
	EXEC SQL SET AUTOCOMMIT TO ON;
	EXEC SQL DROP TABLE IF EXISTS T;
	EXEC SQL CREATE TABLE T ( i int );
	EXEC SQL DISCONNECT;

	for (i = 0; i < THREADS; ++i)
		pg_thrd_create(&threads[i], fn, (void *) i);
	for (i = 0; i < THREADS; ++i)
		pg_thrd_join(threads[i], NULL);

	return 0;
}
